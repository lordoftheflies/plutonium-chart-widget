<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="plutonium-chart-behavior.html">

<!--
`plutonium-causal-chart`
Visualization widget.

@demo demo/index-causal-chart.html 
-->

<dom-module id="plutonium-causal-chart">
    <template>
        <style>
            :host {
                display: block;
                height: 400px;
                position: relative;
            }

            .controls {
                display: inline-block;
                margin: 0 0 0 20px;
            }
            svg {
                float: right;
                margin: 0;
            }
            .axis--x path {
                display: none;
            }

            .line {
                fill: none;
                stroke: steelblue;
                stroke-width: 1.5px;
            }

            #tooltip {
                position: absolute;
                height: auto;
                padding: 10px;
                background-color: white;
                -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                pointer-events: none;
            }

            #tooltip.hidden {
                display: none;
            }

            #imgLines,
            #svg {
                position: absolute;
            }

            #tooltip p {
                margin: 0;
                font-family: sans-serif;
                font-size: 12px;
                line-height: 20px;
            }
        </style>
        <content select=".scale"></content>
        <svg id="svg"></svg>
    </template>

    <script>
        Polymer({
            is: 'plutonium-causal-chart',
            extends: 'div',
            properties: {
                dataUrl: {
                    type: String,
                    notify: true
                },

                xAxisName: {
                    type: String,
                    notify: true
                },
                yAxisName: {
                    type: String,
                    notify: true
                },
                zAxisName: {
                    type: String,
                    notify: true
                },
//                _colorBucketCount: {
//                    type: Number,
//                    computed: '_computeColorBucketCount(data)',
//                },

                _tick: {
                    type: Number,
                    value: 1
                },

                _resolution: {
                    type: Object,
                    computed: '_computeResolution(dataUrl)'
                },
                _cellSizeX: {
                    type: Number,
                    computed: '_computeCellSizeX(_resolution, _height)'
                },
                _cellSizeY: {
                    type: Number,
                    computed: '_computeCellSizeY(_resolution, _width)'
                },
                _selectedPoint: {
                    type: Object,
                    notify: true
                },

                _data: {
                    type: Array,
                    value: []
                }
            },
            behaviors: [
                Plutonium.ChartBehavior
            ],
            observers: [
                '_observeServerSideData(_g, dataUrl)'
            ],

            _computeColorBucketCount: function (data) {
                return (data.domains.z.length && data.domains.z.length > 0) ? data.domains.z.length - 1 : 0;
            },
            _computeCellSizeX: function (resolution, height) {
                return height / resolution.height;
            },
            _computeCellSizeY: function (resolution, width) {
                return width / resolution.width;
            },
            _computeResolution: function (data) {
                return data.resolution;
            },
            _observeServerSideData: function (_cellSizeX, _cellSizeY, _g, dataUrl) {
                console.debug((this.id ? this.is + '#' + this.id : this.is), 'observe-data');
                this.fire('d3-render', {});
            },
            draw: function () {
                var self = this;
                console.debug((this.id ? this.is + '#' + this.id : this.is), 'draw');

//                var zScale = d3.scaleQuantile().domain([
//                    d3.min(this.data.data, function (d) {
//                        return d.z;
//                    }),
//                    this._colorBucketCount,
//                    d3.max(this.data.data, function (d) {
//                        return d.z;
//                    })
//                ]).range(this.data.domains.z);

//                var legendElementWidth = this._width / this.data.domains.z.length;
//                var legendG = this._g.append("g").selectAll(".legend")
//                        .data([0].concat(zScale.quantiles()), function (d) {
//                            return d;
//                        })
//                        .enter()
//                        .append("g").attr("class", "legend");
//
//                legendG.append("rect")
//                        .attr("x", function (d, i) {
//                            return legendElementWidth * i;
//                        }).attr("y", this._height)
//                        .attr("width", legendElementWidth).attr("height", this._cellSizeY)
//                        .style("fill", function (d, i) {
//                            return self.data.domains.z[i].name;
//                        });
//
//                legendG.append("text")
//                        .attr("class", "mono")
//                        .text(function (d) {
//                            return Math.round(d);
//                        })
//                        .attr("x", function (d, i) {
//                            return legendElementWidth * i;
//                        })
//                        .attr("y", this._height + this._cellSizeY + 15);
//
//                legendG.append("text").attr("class", "mono").text(d3.max(this.data.data, function (d) {
//                    return d.z;
//                }))
//                        .attr("x", function (d, i) {
//                            return self._width;
//                        })
//                        .attr("y", this._height + this._cellSizeY + 15);
////                legend.exit().remove();
//

                this._graph = d3.select(this).append('canvas')
//                this._graph = this._g.apped('g').html('<canvas></canvas>')
                        .attr("id", "imgLines")
//                        .attr()
//                        .attr('xlink:href', this.dataUrl)
                        .attr('x', '0')
                        .attr('y', '0')
                        .attr("style", "margin-left: " + this._margin.left + "px; margin-top: " + this._margin.top + "px;")
                        .attr('width', this._width + 'px')
                        .attr('height', this._height + 'px')
                        ;

                console.debug((this.id ? this.is + '#' + this.id : this.is), 'render scales');
                var distributedScales = this.queryAllEffectiveChildren('.scale');
                for (var index in distributedScales) {
                    console.debug('- ', (distributedScales[index].id ? distributedScales[index].is + '#' + distributedScales[index].id : distributedScales[index].is));
                    distributedScales[index].fire('d3-update', {
                        graphics: this._g,
                        container: this._svg,
                        width: this._width,
                        height: this._height,
                        margin: this._margin
                    });
                }
            },
            update: function (data) {
//                console.debug();
                this._graph = this._graph.attr('transform', 'translate(0, ' + (this._tick++) + ')');

//                var line = this._graph
////                        .enter()
//                        .append('svg:image');
//                line.attr('xlink:href', this.dataUrl)
//                        .attr('x', '0')
//                        .attr('y', '0')
//                        .attr('width', this._width + 'px')
//                        .attr('height', 1 + 'px');

                var canvas = document.getElementById('imgLines');
                var context = canvas.getContext("2d");
                var self = this;

                var img = new Image();
                img.src = this.dataUrl;
                img.onload = function () {
                    self._data.push(img);
                    console.debug('add new line', self._data);
                };

                context.beginPath();
                this._data.forEach(function (d, i) {


                    console.debug('draw line', d, i);

                    context.drawImage(d, 0, i);
//                    context.rect(scale(d), 150, 10, 10);
//                    context.fillStyle = "red";
//                    context.fill();

                });
                context.closePath();
            }
        });
    </script>
</dom-module>