<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="plutonium-chart-behavior.html">

<!--
`plutonium-line-chart`
Visualization widget.

@demo demo/index-thin-chart.html 
-->

<dom-module id="plutonium-thin-chart">
    <template>
        <style>
            :host {
                display: block;
                height: 400px;
            }

            .controls {
                display: inline-block;
                margin: 0 0 0 20px;
            }
            svg {
                float: right;
                margin: 0;
            }
            .axis--x path {
                display: none;
            }

            .line {
                fill: none;
                stroke: steelblue;
                stroke-width: 1.5px;
            }

            #tooltip {
                position: absolute;
                height: auto;
                padding: 10px;
                background-color: white;
                -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                pointer-events: none;
            }

            #tooltip.hidden {
                display: none;
            }

            #tooltip p {
                margin: 0;
                font-family: sans-serif;
                font-size: 12px;
                line-height: 20px;
            }
        </style>
        
        <svg id="container"></svg>
        
        <content select=".scale"></content>
        
    </template>

    <script>
        Polymer({
            is: 'plutonium-thin-chart',
            extends: 'div',
            properties: {
                dataUrl: {
                    type: String,
                    notify: true
                },
                
                _resolution: {
                    type: Object,
                    computed: '_computeResolution(dataUrl)'
                },
                _cellSizeX: {
                    type: Number,
                    computed: '_computeCellSizeX(_resolution, _height)'
                },
                _cellSizeY: {
                    type: Number,
                    computed: '_computeCellSizeY(_resolution, _width)'
                },
                _selectedPoint: {
                    type: Object,
                    notify: true
                }
            },
            behaviors: [
                Plutonium.ChartBehavior
            ],
            observers: [
                '_observeServerSideData(_g, dataUrl)'
            ],
            
            _computeColorBucketCount: function (data) {
                return (data.domains.z.length && data.domains.z.length > 0) ? data.domains.z.length - 1 : 0;
            },
            _computeCellSizeX: function (resolution, height) {
                return height / resolution.height;
            },
            _computeCellSizeY: function (resolution, width) {
                return width / resolution.width;
            },
            _computeResolution: function (data) {
                return data.resolution;
            },
            _observeServerSideData: function (_g, dataUrl) {
                console.debug((this.id ? this.is + '#' + this.id : this.is), 'observe-data');
                this.fire('plutonium-render', {});
            },
            draw: function () {
                var self = this;
                console.debug((this.id ? this.is + '#' + this.id : this.is), 'draw');
                var img = new Image();
                img.src = this.dataUrl;
                img.onload = function () {
//                    if (self._g)
//                        self._g.remove();
//                    self._g = self._svg.append("g").attr("transform", "translate(" + self._margin.left + "," + self._margin.top + ")");
                    
//                    try {
////                    if (d3.select('#' + self.id + '-graph')._groups[0][0]) {
//                        d3.select('#' + self.id + '-graph').remove();
////                    } else {
//                        self.$.svg.firstElementChild.firstElementChild.remove();
//                    } catch (exception) {
//                        console.warn(exception);
//                    }
                    
////                        d3.select(self._graph).remove();
//                        
//                    }
                    self._graph = self._g.append('image').attr('xlink:href', self.dataUrl)
                            .attr('id', self.id + '-graph')
                            .attr('x', '0')
                            .attr('y', '0')
                            .attr('width', self._width + 'px')
                            .attr('height', self._height + 'px');
                    console.debug((self.id ? self.is + '#' + self.id : self.is), 'render scales');
                    var distributedScales = self.queryAllEffectiveChildren('.scale');
                    for (var index in distributedScales) {
                        console.debug('- ', (distributedScales[index].id ? distributedScales[index].is + '#' + distributedScales[index].id : distributedScales[index].is));
                        distributedScales[index].fire('d3-update', {
                            graphics: self._g,
                            container: self._svg,
                            width: self._width,
                            height: self._height,
                            margin: self._margin
                        });
                    }
                };
                
                
//                // TODO: separate component
//                this._xAxis = this._g.append("g")
//                        .selectAll(".rowLabelg")
//                        .data(this.data.domains.x)
//                        .enter()
//                        .append("text")
//                        .attr("font-size", (self._cellSizeY - 1) + "px")
//                        .text(function (d) {
//                            return d.name;
//                        })
//                        .attr("x", 0)
//                        .attr("y", function (d, i) {
//                            return self._cellSizeY * i;
//                        })
//                        .style("text-anchor", "end")
//                        .attr("transform", "translate(-6," + (self._cellSizeY / 1.5 + 2) + ")")
//                        .attr("class", function (d, i) {
//                            return "rowLabel mono r" + i;
//                        });
//
//                this._yAxis = this._g.append("g")
//                        .selectAll(".colLabelg")
//                        .data(this.data.domains.y)
//                        .enter()
//                        .append("text")
//                        .attr("font-size", (self._cellSizeX - 1) + "px")
//                        .text(function (d) {
//                            return d.name;
//                        })
//                        .attr("x", 0)
//                        .attr("y", function (d, i) {
//                            return self._cellSizeX * i;
//                        })
//                        .style("text-anchor", "left")
//                        .attr("transform", "translate(" + (self._cellSizeX / 1.5 + 2) + ",-6) rotate (-90)")
//                        .attr("class", function (d, i) {
//                            return "colLabel mono c" + i;
//                        });
            },
            update: function (data) {
//                console.debug();
//                this._graph = d3.select(this._graph).transition()
//                        .duration(750)
//                        .attr('xlink:href', this.dataUrl);
                // Select the section we want to apply our changes to
//                this._svg = d3.select(this).transition();
                
                
                
//                // Scale the range of the data again 
//                var distributedScales = this.queryAllEffectiveChildren('.scale');
//                for (var index in distributedScales) {
//                    console.debug('- ', (distributedScales[index].id ? distributedScales[index].is + '#' + distributedScales[index].id : distributedScales[index].is));
////                    distributedScales[index].scale(this._svg);
//                }
//                
            }
        });
    </script>
</dom-module>