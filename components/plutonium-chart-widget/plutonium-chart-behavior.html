<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<script src="../d3/d3.js"></script>

<script>
    window.Plutonium = window.Plutonium || {};
    /**
     * Behavior that highlights stuff.
     *
     * @polymerBehavior
     */
    Plutonium.ChartBehaviorImpl = {
        extends: 'div',
        properties: {
            _viewport: {
                type: Object,
                notify: true
            },
            _margin: {
                type: Object,
                notify: true,
                value: {
                    top: 20,
                    right: 20,
                    bottom: 30,
                    left: 50
                }
            },
            _width: {
                type: Number,
                computed: '_computeContentWidth(_viewport.width, _margin.left, _margin.right)'
            },
            _height: {
                type: Number,
                computed: '_computeContentHeight(_viewport.height, _margin.top, _margin.bottom)'
            },
            data: {
                type: Object,
                notify: true
            },
            verticalAlign: 'top',
            horizontalAlign: 'auto',
            autoFitOnAttach: true
        },
        observers: [
            '_observeLayout(_viewport, _margin)',
//            '_observeData(_g, data)'
        ],
        listeners: {
            'iron-resize': '_onResizeSvg',
            'd3-render': '_onRender'
        },
        created: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'created');

        },
        ready: function () {
            this._svg = d3.select(this.$.svg);
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'ready');
        },
        attached: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'attached');

        },
        detached: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'detached');
        },
        _onResizeSvg: function (event, details) {
            if (this.offsetWidth > 0 && this.offsetHeight > 0) {
                this._viewport = {
                    width: this.offsetWidth,
                    height: this.offsetHeight
                };
                console.log((this.id ? this.is + '#' + this.id : this.is), 'resized to', this._viewport);
            }
        },
        _observeLayout: function (viewport, margin) {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'observe-lyout', viewport, margin);
            this._svg = this._svg.attr('width', this._viewport.width).attr('height', this._viewport.height);
            if (this._g)
                this._g.remove();
            this._g = this._svg.append("g").attr("transform", "translate(" + this._margin.left + "," + this._margin.top + ")");
        },
//        _observeData: function (g, data) {
////            if (Object.is(data)) {
//            console.debug((this.id ? this.is + '#' + this.id : this.is), 'observe-data', data);
////            this.initialize();
////            }
//        },

        _computeContentWidth: function (viewportWidth, marginLeft, marginRight) {
            return viewportWidth - marginLeft - marginRight;
        },
        _computeContentHeight: function (viewportHeight, marginTop, marginBottom) {
            return viewportHeight - marginTop - marginBottom;
        },

//        _observeInit: function (chart, x, y) {
//            if (!this._chart)
//            this.initialize();
//            this.fire('d3-render', {});
//        },
        _onRender: function (chart, x, y) {
            this.draw();
        },

        initialize: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'initialize');
        },
        draw: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'draw');
        }
    };
    /**
     * Behavior that highlights stuff.
     *
     * @polymerBehavior
     */
    Plutonium.ChartBehavior = [
        Polymer.IronResizableBehavior,
        Plutonium.ChartBehaviorImpl
    ];
</script>