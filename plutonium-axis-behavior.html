<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<script src="../d3/d3.js"></script>

<script>
    window.Plutonium = window.Plutonium || {};

    /**
     * Behavior that highlights stuff.
     *
     * @polymerBehavior
     */
    Plutonium.AxisBehaviorImpl = {
        properties: {
            label: {
                type: String,
                notify: true
            },
            unit: {
                type: String,
                notify: true
            },

            /**
             * Orientation enumeration. 
             * Possible values: left, right, top, bottom.
             * Left and right uninterpretable on vertical axises. 
             * Top and down uninterpretable on horizontal axises. 
             * @type {string} 
             */
            orientation: {
                type: String,
                value: 'left'
            },

            /**
             * Property to control axis type.
             * Possible values: horizontal, vertical, legend.
             * @type {string}
             */
            domain: {
                type: String,
                value: 'horizontal'
            },

            /**
             * Center of the axis.
             * @type {number}
             */
            center: {
                type: Number,
                value: 0.0
            },
            /**
             * Span of the viewed window.
             * @type {number}
             */
            span: {
                type: Number,
                value: 1.0
            },
            /**
             * String pattern for format time based axises.
             * Default is ISO 8601
             * @type {string}
             */
            timeParse: {
                type: String,
                notify: true,
//                value: '%d-%b-%y'
            },
            _scale: {
                type: Object
            },
            _axis: {
                type: Object
            }
        },
        observers: [
            '_observeText(label, unit)',
            '_observeTimeParsePattern(timeParse)',
            '_observeVisiblePart(span, center)',
//            '_observeOrientation(orientation, _scale)'
        ],
        listeners: {
            'iron-resize': '_onResize',
            'd3-update': '_onD3Update'
        },
        created: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'created');
        },
        ready: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'ready');
        },
        attached: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'attached');

        },
        detached: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'detached');
        },

        _onResize: function (event, details) {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'resize');

        },

        _getRange: function (domain, details) {
            var range;
            switch (domain) {
                case 'horizontal':
                    range = [0, details.width];
                    break;
                case 'vertical':
                    range = [details.height, 0];
                    break;
                case 'legend':
                    range = [0, 0];
                    break;
                default:
                    range = [0, 0];
                    break;
            }
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'range', range);
            return range;
        },

        _getRangeByParent: function (domain) {
            var range;
            switch (domain) {
                case 'horizontal':
                    range = [0, this.parentNode._width];
                    break;
                case 'vertical':
                    range = [this.parentNode._height, 0];
                    break;
                case 'legend':
                    range = [0, 0];
                    break;
                default:
                    range = [0, 0];
                    break;
            }
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'range', range);
            return range;
        },

        _onD3Update: function (event, details) {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'd3-draw');

            if (this.timeParse) {
//                this._scale = d3.scaleTime().rangeRound([center - span / 2, center + span / 2]);
                this._ranges = d3.scaleTime().range(this._getRange(this.domain, details));
            } else {
                this._ranges = d3.scaleLinear().range(this._getRange(this.domain, details));
//                this._scale = d3.scaleLinear().rangeRound([center - span / 2, center + span / 2]);
            }



            this._onRender();
        },
        _onRender: function () {
            this._ranges.domain([(this.center - this.span / 2), (this.center + this.span / 2)]);

            var transformationAttribute;
            var transformationAttributeForLabel;
            switch (this.orientation) {
                case 'left':
                    this._axis = d3.axisLeft(this._ranges);
                    transformationAttribute = 'translate(0,0)';
                    transformationAttributeForLabel = 'translate(' + (-this.parentNode._margin.left / 2) + ' ,' + (this.parentNode._height / 2) + ') ' + 'rotate(-90)';
                    break;
                case 'right':
                    this._axis = d3.axisRight(this._ranges);
                    transformationAttribute = 'translate(' + this.parentNode._width + ', 0)';
                    transformationAttributeForLabel = 'translate(' + (this.parentNode._width + this.parentNode._margin.right) + ', ' + (this.parentNode._height / 2) + ')' + ' rotate(90)';
                    break;
                case 'top':
                    this._axis = d3.axisTop(this._ranges);
                    transformationAttribute = 'translate(0,0)';
                    transformationAttributeForLabel = 'translate(' + (this.parentNode._width / 2) + ',' + (-this.parentNode._margin.top) + ')';
                    break;
                case 'bottom':
                    this._axis = d3.axisBottom(this._ranges);
                    transformationAttribute = "translate(0," + this.parentNode._height + ')';
                    transformationAttributeForLabel = "translate(" + (this.parentNode._width / 2) + " ," + (this.parentNode._height + 10 + this.parentNode._margin.top) + ")";
                    break;
                default:
                    console.warn((this.id ? this.is + '#' + this.id : this.is), 'orientation value is invalid:', this.orientation);
                    return;
            }


// text label for the x axis



            if (this.parentNode._g) {
                d3.select('#' + this.id + '-axis').remove();
                this._axisGraphics = this.parentNode._g.append("g")
                        .attr("id", this.id + "-axis")
                        .attr("class", "axis")
                        .attr("transform", transformationAttribute)
                        .call(this._axis);

                d3.select('#' + this.id + '-axis-label').remove();
                this._axisLabel = this.parentNode._g.append("text")
                        .attr("id", this.id + "-axis-label")
                        .attr("class", "axis-label")
                        .attr("transform", transformationAttributeForLabel)
                        .style("text-anchor", "middle")
                        .text(this.label + " (" + this.unit + ")")
                        .attr("class", 'axis-label');
            }
        },

        _observeTimeParsePattern: function (timeParse) {
            if (timeParse) {
                this._parseTime = d3.timeParse(timeParse);
                console.debug((this.id ? this.is + '#' + this.id : this.is), 'set ne time pattern', timeParse);
            }
//            this._onRender();
        },
        _observeVisiblePart: function (span, center) {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'observe visible parts with center', '=', center, ',', 'span', '=', span);
//            if (this.timeParse) {
//                this._ranges = d3.scaleTime().range([center - span / 2, center + span / 2]);
//            } else {
//                this._ranges = d3.scaleLinear().range([center - span / 2, center + span / 2]);
//            }

            if (this.timeParse) {
//                this._scale = d3.scaleTime().rangeRound([center - span / 2, center + span / 2]);
                this._ranges = d3.scaleTime().range(this._getRangeByParent(this.domain));
            } else {
                this._ranges = d3.scaleLinear().range(this._getRangeByParent(this.domain));
//                this._scale = d3.scaleLinear().rangeRound([center - span / 2, center + span / 2]);
            }

            this._onRender();
//            d3.select(Polymer.dom(this).parentNode) // change the x axis
//                    .duration(1000)
//                    .call(this._axis);
        },

        _observeOrientation: function (orientation, _scale) {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'observe orientation', 'orientation', '=', orientation);
//            this._scale = d3.scaleOrdinal(); //.padding(0.1);
            switch (orientation) {
                case 'left':
                    this._axis = d3.axisLeft(_scale);
                    break;
                case 'right':
                    this._axis = d3.axisRight(_scale);
                    break;
                case 'top':
                    this._axis = d3.axisTop(_scale);
                    break;
                case 'bottom':
                    this._axis = d3.axisBottom(_scale);
                    break;
                default:
                    console.warn((this.id ? this.is + '#' + this.id : this.is), 'orientation value is invalid:', this.orientation);
                    return;
            }

//            this._onRender();
        },

        _observeText: function (title, unit) {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'observe textual attributes', title, unit);
            this._onRender();
        }
    };

    /**
     * Behavior that highlights stuff.
     *
     * @polymerBehavior
     */
    Plutonium.AxisBehavior = [
        Polymer.IronResizableBehavior,
        Plutonium.AxisBehaviorImpl
    ];
</script>
