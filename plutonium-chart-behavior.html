<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<script src="../d3/d3.js"></script>

<script>
    window.Plutonium = window.Plutonium || {};
    /**
     * Behavior that highlights stuff.
     *
     * @polymerBehavior
     */
    Plutonium.ChartBehaviorImpl = {
        extends: 'div',
        properties: {
            _viewport: {
                type: Object,
                notify: true
            },
            _margin: {
                type: Object,
                notify: true,
                value: {
                    top: 30,
                    right: 30,
                    bottom: 30,
                    left: 30
                }
            },
            _width: {
                type: Number,
                notify: true
            },
            _height: {
                type: Number,
                notify: true
            },
            loading: {
                type: Boolean,
                notify: true,
                value: false
            }
        },
        observers: [
            '_observeLayout(_viewport, _margin)',
            '_observerContentArea(_width, _height)',
            '_computeContentWidth(_viewport.width, _margin.left, _margin.right)',
            '_computeContentHeight(_viewport.height, _margin.top, _margin.bottom)'
        ],
        listeners: {
            'iron-resize': '_onResize',
            'plutonium-render': '_onRender'
        },
        created: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'created');
        },
        ready: function () {
            this._svg = d3.select(this.$.container);
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'ready');
        },
        attached: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'attached');
        },
        detached: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'detached');
        },
        _onResize: function (event, details) {
            if (this.offsetWidth > 0 && this.offsetHeight > 0) {
                this._viewport = {
                    width: this.offsetWidth,
                    height: this.offsetHeight
                };
                console.log((this.id ? this.is + '#' + this.id : this.is), 'resized to', this._viewport);
            }

            this.draw();
        },
        _observeLayout: function (viewport, margin) {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'observe-layout', viewport, margin);
            this._svg = this._svg.attr('width', this._viewport.width).attr('height', this._viewport.height);
            if (this._g)
                this._g.remove();
            this.initialize();

        },
        _observerContentArea: function (width, height) {
            this.fire('plutonium-chart-resize', {
                id: this.id,
                width: width,
                height: height
            });
            this.$.canvas.width = width;
            this.$.canvas.height = height;
        },
        _computeContentWidth: function (viewportWidth, marginLeft, marginRight) {
            this._width = viewportWidth - marginLeft - marginRight;
        },
        _computeContentHeight: function (viewportHeight, marginTop, marginBottom) {
            this._height = viewportHeight - marginTop - marginBottom;
        },
        _onRender: function (chart, x, y) {
            this.draw();
            
            this.loading = false;
        },
        draw: function () {
            console.debug((this.id ? this.is + '#' + this.id : this.is), 'draw should be overridden');
        }
    };
    /**
     * Behavior that highlights stuff.
     *
     * @polymerBehavior
     */
    Plutonium.ChartBehavior = [
        Polymer.IronResizableBehavior,
        Plutonium.ChartBehaviorImpl
    ];
</script>